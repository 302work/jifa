<?xml version="1.0" encoding="UTF-8"?>

<ViewConfig>
  <Arguments/>
  <Context/>
  <Model>
    <DataType name="Account">
      <Property name="creationType">com.account.pojo.Account</Property>
      <Property name="defaultDisplayProperty">name</Property>
      <Reference name="child">
        <Property name="dataProvider">accountService#getAccountsByParentId</Property>
        <Property name="dataType">[SELF]</Property>
        <Property name="parameter">$${this.id}</Property>
      </Reference>
      <Reference name="records">
        <Property name="dataProvider">recordService#getRecordsByAccountId</Property>
        <Property name="dataType">[Record]</Property>
        <Property name="pageSize">20</Property>
        <Property name="parameter">$${this.id}</Property>
      </Reference>
      <PropertyDef name="name">
        <Property name="dataType">String</Property>
        <Property name="required">true</Property>
        <Property name="label">名称</Property>
      </PropertyDef>
      <PropertyDef name="id">
        <Property name="dataType">Long</Property>
        <Property name="label">ID</Property>
      </PropertyDef>
      <PropertyDef name="parentAccountId">
        <Property name="dataType">Long</Property>
      </PropertyDef>
    </DataType>
    <DataType name="Record">
      <Property name="creationType">com.account.pojo.Record</Property>
      <PropertyDef name="type">
        <Property name="dataType">Integer</Property>
        <Property name="label">类型</Property>
        <Property name="required">true</Property>
        <Property name="mapping">
          <Property name="mapValues">
            <Collection>
              <Entity>
                <Property name="key">1</Property>
                <Property name="value">支出</Property>
              </Entity>
              <Entity>
                <Property name="key">2</Property>
                <Property name="value">收入</Property>
              </Entity>
            </Collection>
          </Property>
        </Property>
      </PropertyDef>
      <PropertyDef name="name">
        <Property name="dataType">String</Property>
        <Property name="label">名称</Property>
        <Property name="required">true</Property>
      </PropertyDef>
      <PropertyDef name="id">
        <Property name="dataType">Long</Property>
        <Property name="label">ID</Property>
      </PropertyDef>
      <PropertyDef name="doDate">
        <Property name="dataType">Date</Property>
        <Property name="displayFormat">Y-m-d</Property>
        <Property name="label">日期</Property>
        <Property name="required">true</Property>
      </PropertyDef>
      <PropertyDef name="money">
        <Property name="dataType">Double</Property>
        <Property name="label">金额</Property>
        <Property name="required">true</Property>
      </PropertyDef>
      <PropertyDef name="accountId">
        <Property name="dataType">Long</Property>
      </PropertyDef>
      <PropertyDef name="accountName">
        <Property name="dataType">String</Property>
        <Property name="label">账户</Property>
      </PropertyDef>
      <PropertyDef name="remark">
        <Property name="dataType">String</Property>
      </PropertyDef>
      <PropertyDef name="tag">
        <Property name="dataType">String</Property>
        <Property name="label">标签</Property>
      </PropertyDef>
    </DataType>
  </Model>
  <View layout="padding:20">
    <DataSet id="dsAccounts">
      <Property name="dataProvider">accountService#getAccountsByParentId</Property>
      <Property name="dataType">[Account]</Property>
      <Property name="readOnly">true</Property>
    </DataSet>
    <SplitPanel>
      <Property name="position">200</Property>
      <MainControl>
        <Panel layout="padding:1">
          <Property name="caption">明细</Property>
          <Property name="icon">url(&gt;skin&gt;common/icons.gif) -180px -140px</Property>
          <Buttons/>
          <Children>
            <ToolBar>
              <DataPilot/>
              <Separator/>
              <ToolBarButton>
                <Property name="caption">导出</Property>
                <Property name="icon">url(&gt;skin&gt;common/icons.gif) -180px -120px</Property>
              </ToolBarButton>
              <Separator/>
              <ToolBarButton>
                <Property name="caption">打印</Property>
                <Property name="icon">url(&gt;skin&gt;common/icons.gif) -120px -20px</Property>
              </ToolBarButton>
            </ToolBar>
            <DataGrid>
              <Property name="dataPath">!CURRENT_ACCOUNT.records</Property>
              <Property name="dataSet">dsAccounts</Property>
              <DataColumn>
                <Property name="property">name</Property>
                <Editor/>
              </DataColumn>
              <DataColumn>
                <Property name="property">money</Property>
                <Editor/>
              </DataColumn>
              <DataColumn>
                <Property name="property">type</Property>
                <Editor/>
              </DataColumn>
              <DataColumn>
                <Property name="property">doDate</Property>
                <Editor/>
              </DataColumn>
            </DataGrid>
          </Children>
          <Tools/>
        </Panel>
      </MainControl>
      <SideControl>
        <Panel layout="padding:1">
          <Property name="caption">分类</Property>
          <Property name="icon">url(&gt;skin&gt;common/icons.gif) -260px -40px</Property>
          <Buttons/>
          <Children>
            <DataTree id="dataTreeAccount">
              <Property name="currentNodeDataPath">CURRENT_ACCOUNT</Property>
              <Property name="dataSet">dsAccounts</Property>
              <BindingConfigs>
                <BindingConfig>
                  <Property name="childrenProperty">child</Property>
                  <Property name="expandLevel">2</Property>
                  <Property name="labelProperty">name</Property>
                  <Property name="recursive">true</Property>
                </BindingConfig>
              </BindingConfigs>
              <ClientEvent name="onContextMenu" signature="self,arg">view.id("menuAccounts").show({
  position: {
    left: arg.event.pageX,
    top: arg.event.pageY
  }
});</ClientEvent>
              <ClientEvent name="beforeCurrentChange" signature="self,arg">var node=arg.oldCurrent;
if(node){
	var data=node.get("data");
	if(data &amp;&amp; data.state!=dorado.Entity.STATE_NONE){
		alert(1);
    view.id("updateActionSaveAccounts").execute();
		if(data.validate()!="ok"){
			arg.processDefault=false;
		}
	}
}</ClientEvent>
              <ClientEvent name="onDraggingSourceDrop" signature="self,arg">var draggingInfo=arg.draggingInfo;
if(!draggingInfo){
	return true;
}
var parentNode=draggingInfo.get("targetObject");
if(!parentNode){
	return true;
}
var parentId=parentNode.get("data.id");
parentNode.get("nodes").each(function(node){
	var data=node.get("data");
	data.set("parentAccountId",parentId);
});
alert("move");
view.id("updateActionSaveAccounts").execute();</ClientEvent>
            </DataTree>
          </Children>
          <Tools/>
        </Panel>
      </SideControl>
    </SplitPanel>
    <Menu id="menuAccounts">
      <MenuItem>
        <Property name="caption">添加一级分类</Property>
        <Property name="icon"> url(&gt;skin&gt;common/icons.gif) -260px -100px</Property>
        <ClientEvent name="onClick" signature="self,arg">var dsAccount = view.id("dsAccounts");
var entity = dsAccount.getData().insert();
this.id("dataTreeAccount").set("currentEntity", entity);
view.id("accountDialog").show();</ClientEvent>
      </MenuItem>
      <MenuItem>
        <Property name="caption">添加子分类</Property>
        <Property name="icon"> url(&gt;skin&gt;common/icons.gif) -280px -120px</Property>
        <ClientEvent name="onClick" signature="self,arg">var treeAccount = this.id("dataTreeAccount");
var currentEntity = treeAccount.get("currentEntity");

var currentNode = view.get("#dataTreeAccount.currentNode");
if(!currentNode){
	dorado.MessageBox.alert("请先选中一个父分类!");
	return;
}

if (currentEntity) {
	   newEntity = currentEntity.createChild("child", {
        parentAccountId: currentEntity.get("id")
    });
	console.log(currentEntity);
    treeAccount.get("currentNode").expand();
    treeAccount.set("currentEntity", newEntity);
}
</ClientEvent>      </MenuItem>      <MenuItem>        <Property name="caption">删除分类</Property>
        <Property name="icon"> url(&gt;skin&gt;common/icons.gif) -40px -0px</Property>
        <ClientEvent name="onClick" signature="self,arg">var treeAccount = this.id("dataTreeAccount");
var currentEntity = treeAccount.get("currentEntity");
if (currentEntity) {
  view.id("ajaxActionCheckAccountChildren").set("parameter", currentEntity.get("id")).execute(function(count) {
    if (count &gt; 0) {
      dorado.MessageBox.alert("请先删除子分类");
    } else {
      dorado.MessageBox.confirm("是否确定删除此分类及该分类的所有记录？", function() {
        currentEntity.remove();
        view.id("updateActionSaveAccounts").execute();
      });
    }
  });
}</ClientEvent>
      </MenuItem>
    </Menu>
    <AjaxAction id="ajaxActionCheckAccountChildren">
      <Property name="service">accountService#checkAccount</Property>
    </AjaxAction>
    <UpdateAction id="updateActionSaveAccounts">
      <Property name="dataResolver">accountService#saveAccounts</Property>
      <UpdateItem>
        <Property name="dataSet">dsAccounts</Property>
      </UpdateItem>
    </UpdateAction>
    <Dialog id="accountDialog">
      <Property name="caption">添加/编辑分类</Property>
      <Property name="width">400</Property>
      <Property name="height">400</Property>
      <Buttons>
        <Button>
          <Property name="caption">保存</Property>
          <Property name="action">updateActionSaveAccounts</Property>
        </Button>
        <Button>
          <Property name="caption">取消</Property>
          <ClientEvent name="onClick" signature="self,arg">view.id("accountDialog").hide();</ClientEvent>
        </Button>
      </Buttons>
      <Children>
        <AutoForm>
          <Property name="dataSet">dsAccounts</Property>
          <AutoFormElement>
            <Property name="name">name</Property>
            <Property name="property">name</Property>
            <Editor/>
          </AutoFormElement>
        </AutoForm>
      </Children>
      <Tools/>
    </Dialog>
  </View>
</ViewConfig>
